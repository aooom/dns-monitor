name: DNS Monitor (Latest Only)

on:
  schedule:
    # 每小时运行一次
    - cron: '0 * * * *'
  workflow_dispatch: # 允许手动触发

permissions:
  contents: write

jobs:
  check-dns:
    runs-on: ubuntu-latest
    steps:
      # 1. 检出代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. 配置 Git
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      # 3. 执行 DNS 查询与日志生成
      - name: Query DNS and Update Log
        run: |
          # 定义文件名
          LOG_FILE="dns_current.log"
          TMP_LOG="dns_current.tmp"
          
          # --- 函数：获取某个域名的上一次IP ---
          function get_old_ip() {
            local domain=$1
            # 从旧日志查找对应域名的IP (精确匹配第2列)
            awk -v d="$domain" '$2 == d {print $1}' "$LOG_FILE" 2>/dev/null | head -n 1
          }

          # --- 开始处理 ---
          
          # 创建临时文件，写入表头
          echo "# Latest DNS Status - Updated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" > "$TMP_LOG"
          echo "# Format: IP Domain # Optional Comment" >> "$TMP_LOG"
          
          if [ ! -f "urls.txt" ]; then
            echo "Error: urls.txt not found!"
            exit 1
          fi

          # 循环读取 urls.txt
          while IFS= read -r line || [[ -n "$line" ]]; do
            # 跳过空行和注释
            if [[ -z "$line" || "$line" =~ ^# ]]; then
              continue
            fi

            # 提取域名
            DOMAIN=$(echo "$line" | sed -e 's|^[^/]*//||' -e 's|/.*$||')
            
            # 查询 DNS (A记录)
            # --- 核心修改在这里 ---
            # 新增了: | head -n 1
            # 作用: 无论 dig 返回多少个 IP，只取第一个
            NEW_IP=$(dig +short "$DOMAIN" A +time=3 +tries=1 2>/dev/null | head -n 1)

            # --- 判断结果 ---
            if [ -n "$NEW_IP" ]; then
              # 1. 查询成功：写入 "IP 域名"
              echo "$NEW_IP $DOMAIN" >> "$TMP_LOG"
            else
              # 2. 查询失败：尝试获取上一次的 IP
              OLD_IP=$(get_old_ip "$DOMAIN")
              
              if [ -n "$OLD_IP" ]; then
                # 有历史记录：写入 "旧IP 域名 # Timeout"
                echo "$OLD_IP $DOMAIN # Timeout" >> "$TMP_LOG"
              else
                # 无历史记录：标记为 Unknown
                echo "Unknown $DOMAIN # Timeout (No History)" >> "$TMP_LOG"
              fi
            fi

          done < "urls.txt"

          # 覆盖旧日志
          mv "$TMP_LOG" "$LOG_FILE"
          
          # 输出结果预览
          echo "=== Current Log File Contents ==="
          cat "$LOG_FILE"

      # 4. 提交更改
      - name: Commit changes
        run: |
          if [[ -n $(git status --porcelain) ]]; then
            git add dns_current.log
            git commit -m "Update latest DNS snapshot"
            git push
          else
            echo "No changes to commit."
          fi